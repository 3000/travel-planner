- content_for :title, t('.title')

%div{class: 'row'}
  %div{class: 'col-md-3 col-sm-3'}
    %img{class: 'img-responsive', src: 'http://lorempixel.com/300/300/city/', width: '100%'}
  %div{class: 'col-md-9 col-sm-9'}
    - if user_signed_in? and @trip.include_user(current_user)
      %div{class: 'btn-toolbar pull-right'}
        = link_to edit_trip_path(@trip), class: 'btn btn-success' do
          = fa_icon 'pencil'

        - if @trip.author_user_id == current_user.id
          = link_to trip_path(@trip), class: 'btn btn-danger', method: :delete, 'data-confirm'=> t('common.delete_confirm') do
            = fa_icon 'times'

    %h3
      = @trip.name
      %small
        = l @trip.start_date, format: :month
    %p
      = @trip.short_description
    %h4
      = t('.travellers')
    - @trip.users.each do |user|
      %p
        = link_to user.full_name, user_path(user)

%hr

%div{'ng-controller' => 'PlanController'}
  %div{class: 'row'}
    %div{class: 'col-md-12'}
      %h3{class: 'pull-left'}
        = t('.plan')
      %div{class: 'btn-toolbar'}
        %a{href: 'javascript:void(0);', 'ng-click' => 'setEdit(true)', class: 'btn btn-primary pull-right btn-sm', 'ng-show' => '!edit'}
          = fa_icon 'edit', text: t('.edit_plan')
        %a{href: 'javascript:void(0);', 'ng-click' => 'setEdit(false)', class: 'btn btn-primary pull-right btn-sm', 'ng-show' => 'edit'}
          = fa_icon 'eye', text: t('.show_plan')
        %a{href: 'javascript:void(0);', 'ng-click' => 'savePlan()', class: 'btn btn-success pull-right btn-sm',
          'ng-disabled' => 'saving'}
          = fa_icon 'save', text: t('.save_plan')

  %table{class: 'table table-bordered'}
    %thead
      %tr
        %th{class: 'col-md-1'}
          = t('.day')
        %th{class: 'col-md-2'}
          = t('.place')
        %th{class: 'col-md-3'}
          = t('.transfers')
        %th{class: 'col-md-2'}
          = t('.hotel')
        %th{class: 'col-md-2'}
          = t('.activities')
        %th{class: 'col-md-2'}
          = t('.comments')

    %tbody
      %tr{'ng-repeat' => 'day in days'}

        %td
          {{day.date}}

        %td
          %div{'ng-show' => '!edit', 'ng-repeat' => 'place in day.places'}
            %p
              {{place.city_text}}

          %div{'ng-show' => 'edit'}

            %div{'ng-repeat' => 'place in day.places', style: 'position: relative'}
              %a{href: 'javascript:void(0);',  style: 'position: absolute; right: 25px; top: 8px',
                'ng-click' => 'fillAsPreviousPlace(place, $index, day, $parent.$index)',
                'ng-show' => '($index > 0 || $parent.$index >0) && !place.city_code'}
                = fa_icon 'arrow-up'

              %a{href: 'javascript:void(0);', 'ng-click' => 'remove(day.places, $index)', 'ng-show' => '$index > 0',
                style: 'position: absolute; right: 5px; top: 8px'}
                = fa_icon 'times'
              %div{class: 'form-group'}
                = render 'widgets/typeahead/cities', model_name: 'place.city', classes: 'input-sm form-control', placeholder: t('.city')

            %div{class: 'form-group'}
              %a{href: 'javascript:void(0);', class: 'btn btn-success btn-sm pull-right', 'ng-click' => 'add(day.places)'}
                = fa_icon 'plus'

        %td
          %div{'ng-show' => '!edit', 'ng-repeat' => 'transfer in day.transfers'}
            %p
              TRANSFER PLACE

          %div{'ng-show' => 'edit'}
            %div{'ng-repeat' => 'transfer in day.transfers', style: 'position: relative', class: 'form-horizontal'}
              %p
                %u
                  Трансфер
                %a{href: 'javascript:void(0);', 'ng-click' => 'remove(day.transfers, $index)', class: 'pull-right'}
                  = fa_icon 'times'

              %div{class: 'form-group'}
                %div{class: 'col-md-6'}
                  = render 'widgets/typeahead/cities', model_name: 'transfer.city_from', classes: 'input-sm form-control', placeholder: 'Из'
                %div{class: 'col-md-6'}
                  = render 'widgets/typeahead/cities', model_name: 'transfer.city_to', classes: 'input-sm form-control', placeholder: 'В'

              %div{class: 'form-group'}
                %div{class: 'col-md-12'}
                  = select_tag 'transfer_type', options_for_select(Travels::Transfer::Types::OPTIONS), {class: 'form-control input-sm selectpicker', 'ng-model' => 'transfer.type'}

              %div{class: 'form-group'}
                %div{class: 'col-md-6 dropdown'}
                  %a{id: 'dropdown-time-start-{{$index}}', class: 'dropdown-toggle', role: 'button', 'data-toggle' => 'dropdown', 'data-target' => '#', href: 'javascript:void(0);'}
                    {{transfer.start_time | date:'dd.MM.yyyy HH:mm' }}
                    %span{'ng-show' => '!transfer.start_time'}
                      Отправление
                  %ul{class: 'dropdown-menu', role: 'menu', 'aria-labelledby' => 'dLabel'}
                    %datetimepicker{'data-ng-model'=>'transfer.start_time',
                      'data-datetimepicker-config' => "{ dropdownSelector: 'dropdown-time-start-{{$index}}', weekStart: 1 }",
                      'data-on-set-time' => 'onTimeSet'}

                %div{class: 'col-md-6 dropdown'}
                  %a{id: 'dropdown-time-end-{{$index}}', class: 'dropdown-toggle', role: 'button', 'data-toggle' => 'dropdown', 'data-target' => '#', href: 'javascript:void(0);'}
                    {{transfer.end_time | date:'dd.MM.yyyy HH:mm' }}
                    %span{'ng-show' => '!transfer.end_time'}
                      Прибытие
                  %ul{class: 'dropdown-menu', role: 'menu', 'aria-labelledby' => 'dLabel'}
                    %datetimepicker{'data-ng-model'=>'transfer.end_time',
                      'data-datetimepicker-config' => "{ dropdownSelector: 'dropdown-time-end-{{$index}}', weekStart: 1 }",
                      'data-on-set-time' => 'onTimeSet'}

              %div{class: 'form-group'}
                %div{class: 'col-md-12'}
                  = text_area_tag 'transfer_comment', '', 'ng-model' => 'transfer.comment', class: 'form-control', placeholder: 'Комментарий', rows: 6


              %div{class: 'form-group'}
                %div{class: 'col-md-4'}
                  = text_field_tag 'transfer_code', '', 'ng-model' => 'transfer.code', class: 'input-sm form-control', placeholder: '№'
                %div{class: 'col-md-8'}
                  = text_field_tag 'transfer_company', '', 'ng-model' => 'transfer.company', class: 'input-sm form-control', placeholder: 'Перевозчик'

              %div{class: 'form-group'}
                %div{class: 'col-md-6'}
                  = text_field_tag 'transfer_station_from', '', 'ng-model' => 'transfer.station_from', class: 'input-sm form-control', placeholder: 'От станции'

                %div{class: 'col-md-6'}
                  = text_field_tag 'transfer_station_to', '', 'ng-model' => 'transfer.station_to', class: 'input-sm form-control', placeholder: 'До станции'

              %hr

            %div{class: 'form-group pull-right'}
              %a{href: 'javascript:void(0);', class: 'btn btn-success btn-sm', 'ng-click' => 'add(day.transfers)'}
                = fa_icon 'plus'

        %td
        %td
        %td
