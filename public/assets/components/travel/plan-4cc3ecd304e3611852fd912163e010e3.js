(function(){angular.module("travel-components").controller("PlanController",["$scope","Trip","$location","$window","$interval",function(e,t,i,r,n){return e.uuid=function(){var e;return e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e.trip_id=/trips\/([a-zA-Z0-9]+)/.exec(i.absUrl())[1],e.tripService=t.init(e.trip_id),e.activitiesCollapsed=!0,e.transfersCollapsed=!0,e.edit=!1,e.show_place=!0,e.show_transfers=!0,e.show_hotel=!0,e.show_activities=!0,e.show_comments=!0,n(function(){return $.ajax({url:"/api/user_shows/"+e.trip_id,type:"GET",success:function(t){return e.users=t}})},2e3),e.setEdit=function(t){return t?(e.activitiesCollapsed=!1,e.toggleActivities(!1)):(e.activitiesCollapsed=!0,e.toggleActivities(!1)),e.edit=t},e.createDays=function(t,i){return 0!==t&&(e.days=new Array(t)),e.trip=i},e.load=function(){return e.tripService.getTrip().then(function(t){return e.trip=t})},e.add=function(e,t){return null==t&&(t={}),t.id=(new Date).getTime(),e.push(t)},e.remove=function(e,t){return e.splice(t,1)},e.fillAsPreviousPlace=function(t,i,r,n){var s,o;return r.places[i-1]?o=r.places[i-1]:(s=e.days[n-1],o=s.places[s.places.length-1]),t.city_code=o.city_code,t.city_text=o.city_text},e.fillAsPreviousHotel=function(t,i){var r,n,s,o,a,l,c;if(n=e.days[i-1],s=n.hotel){for(t.name=s.name,t.price=s.price,t.links=[],l=s.links,c=[],o=0,a=l.length;a>o;o++)r=l[o],c.push(t.links.push(JSON.parse(JSON.stringify(r))));return c}},e.budget=function(){var t,i,r,n,s,o,a,l,c,u,p,f,d,v,h,g,y;if(n=0,!e.days)return 0;for(v=e.days,o=0,u=v.length;u>o;o++)if(i=v[o]){if(i.hotel&&(n+=parseInt(i.hotel.price||0,10)),i.transfers)for(h=i.transfers,a=0,p=h.length;p>a;a++)s=h[a],n+=parseInt(s.price||0,10);if(i.activities)for(g=i.activities,l=0,f=g.length;f>l;l++)t=g[l],n+=parseInt(t.price||0,10);if(i.expenses)for(y=i.expenses,c=0,d=y.length;d>c;c++)r=y[c],n+=parseInt(r.price||0,10)}return n||0},e.savePlan=function(){return e.saving?void 0:(e.saving=!0,e.tripService.updateTrip(e.trip).then(function(){return e.days?void 0:e.saving=!1}),e.days?e.tripService.createDays(e.days).then(function(){return e.saving=!1}):void 0)},e.cancelEdits=function(){var t,i,r,n;if(e.setEdit(!1),e.days)for(n=e.days,i=0,r=n.length;r>i;i++)t=n[i],e.tripService.reloadDay(t,function(t){return e.setDayCollapse(t,"transfers"),e.setDayCollapse(t,"activities")});return e.load()},e.setDayCollapse=function(t,i){var r,n,s,o,a;if(t&&t[i]){for(o=t[i],a=[],n=0,s=o.length;s>n;n++)r=o[n],a.push(r.isCollapsed=e[""+i+"Collapsed"]);return a}},e.toggleCollapse=function(t,i){var r,n,s,o,a;if(null==t&&(t=!0),t&&(e[""+i+"Collapsed"]=!e[""+i+"Collapsed"]),e.days){for(o=e.days,a=[],n=0,s=o.length;s>n;n++)r=o[n],a.push(e.setDayCollapse(r,i));return a}},e.toggleActivities=function(t){return null==t&&(t=!0),e.toggleCollapse(t,"activities")},e.toggleTransfers=function(t){return null==t&&(t=!0),e.toggleCollapse(t,"transfers")},e.downloadWord=function(){var t,i,n,s,o;for(i="/trips/"+e.trip_id+".docx?",o=["show_place","show_transfers","show_hotel","show_activities","show_comments"],n=0,s=o.length;s>n;n++)t=o[n],e[t]&&(i+="&cols[]="+t);return r.open(i,"_blank"),!0}}])}).call(this);